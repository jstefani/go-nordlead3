package nordlead3

import (
	"bytes"
	"errors"
	"fmt"
	"testing"
)

const (
	invalidPerformance       = "F0337F092900004F72636865737472612020202020484E000000000000000000000000000000000078001E007008000202014000000000760007436170297402050241605060080000000000DEADBEEF000000000000000C0621192D466205647032596C764B3C402024134A372349526E335C6000000000000000000002191A62305C6E3308000000000000000000004C32582C443B256861390804020100404827000C60287F6B5900190A40203F5E1140667F42402000003F403213000000000000131A20155A000000096807485858560F0022746132027404404000002B120F7F7C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000E000000000000000000000000000000000000000000000000000700004045204000223F262822407F45383E4F002C252B0F0063006439640000000000000D454B0000000000100F0000000C1E00410830600160012200000217001F7F7800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001D200000014A000000000110000007486002080000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000E000033000000384800500001017E3336031B7E0A010660017E0148680000000000000001003A6800000000201E226262583C010B5B05480B50120200000228003F7F720000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000138002A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400038000000000000000000000000000000000000000000000000001C00006618017C0314007C0002037C2A4C06377C1400750C017E67111E600000000000006A005D5000000000403C454545307802000545400340405800000C50007F7F68000000000000000000000000000000000000000000000000002B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200100007000000000000000000000000000000000000000000000000000380400F7"
	invalidProgram           = "F0337F0921000057656C636F6D650000000000000000000B0000000000000000000000000000000078001E00063000080009726F7A03701F681640116C44200A20104B00190B2000000000000006100A79000004040403642C2C2B0740102B2C18013A016028010045000F7F7E000000DEADBEEF000000000000001E40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000800070000000000000000000000000000000000000000000000000002601440F7"
	validPerformance         = "F0337F092901024F72636865737472612020202020484E000000000000000000000000000000000078001E00700800020201400000000076000743617029740205024160506008000000000000000000000000000000000C0621192D466205647032596C764B3C402024134A372349526E335C6000000000000000000002191A62305C6E3308000000000000000000004C32582C443B256861390804020100404827000C60287F6B5900190A40203F5E1140667F42402000003F403213000000000000131A20155A000000096807485858560F0022746132027404404000002B120F7F7C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000E000000000000000000000000000000000000000000000000000700004045204000223F262822407F45383E4F002C252B0F0063006439640000000000000D454B0000000000100F0000000C1E00410830600160012200000217001F7F7800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001D200000014A000000000110000007486002080000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000E000033000000384800500001017E3336031B7E0A010660017E0148680000000000000001003A6800000000201E226262583C010B5B05480B50120200000228003F7F720000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000138002A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400038000000000000000000000000000000000000000000000000001C00006618017C0314007C0002037C2A4C06377C1400750C017E67111E600000000000006A005D5000000000403C454545307802000545400340405800000C50007F7F68000000000000000000000000000000000000000000000000002B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200100007000000000000000000000000000000000000000000000000000380400F7"
	validPerformanceBank     = 1
	validPerformanceLocation = 2
	validPerformanceName     = "Orchestra     HN"
	validPerformanceVersion  = 1.20
	validProgram             = "F0337F0920020257656C636F6D650000000000000000000B0000000000000000000000000000000078001E00063000080009726F7A03701F681640116C44200A20104B00190B2000000000000006100A79000004040403642C2C2B0740102B2C18013A016028210045200F7F7E00000000000000000000000000001E400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005415100173F554F70031D7E5F3F5F6E037C053E771C132D636A4C367F127C000202012070482C180E08042231285C301A0E072372090C48261402600B60F7"
	validProgramBank         = 2
	validProgramLocation     = 2
	validProgramName         = "Welcome         "
	validProgramVersion      = 1.20
)

func TestDumpSysex(t *testing.T) {
	memory := new(PatchMemory)
	inputSysex := stringToBytes(validProgram)
	inputSysexStruct, err := ParseSysex(inputSysex)
	if err != nil {
		t.Errorf("Test sysex seems incorrect, need valid sysex to test dumping: %q", err)
	}
	programSysex := inputSysexStruct.rawBitstream()

	err = memory.LoadFromSysex(inputSysex)
	if err != nil {
		t.Errorf("Test sysex seems incorrect, need valid sysex to test dumping: %q", err)
	}
	program := memory.Programs[validProgramBank][validProgramLocation].Program

	outputSysex, err := program.dumpSysex()
	if err != nil {
		t.Errorf("Error dumping program: %q", err)
	}

	// Use string format for quick equal comparison
	if bytesToString(*outputSysex) != bytesToString(programSysex) {
		decodedPS := unpackSysex(programSysex)
		decodedOS := unpackSysex(*outputSysex)
		fmt.Printf("Input:  %x\n", decodedPS)
		fmt.Printf("Output: %x\n", decodedOS)

		location, explanation := locationOfDifference(decodedPS, decodedOS)
		t.Errorf("Dumped sysex does not match input at offset %d (%d): %q", location, location*8, explanation)
	}
}

func TestPackAndUnpackSysex(t *testing.T) {
	sysex, _ := ParseSysex(stringToBytes(validProgram))
	bitsToRepack := sysex.decodedBitstream
	repackedBits := unpackSysex(packSysex(bitsToRepack))

	if string(bitsToRepack) != string(repackedBits) {
		t.Errorf("Pack and Unpack not symmetric: %x / %x", tailBytes(bitsToRepack, 8), tailBytes(repackedBits, 8))
	}
}

// Utilities

func stringToBytes(s string) []byte {
	var result []byte
	fmt.Sscanf(s, "%X", &result)
	return result
}

func bytesToString(b []byte) string {
	return fmt.Sprintf("%x", b)
}

func locationOfDifference(b1, b2 []byte) (int, error) {
	r1 := bytes.NewReader(b1)
	r2 := bytes.NewReader(b2)
	i := 0

	for {
		c1, err1 := r1.ReadByte()
		c2, err2 := r2.ReadByte()
		if c1 == c2 && err1 == err2 {
			// skip
		} else {
			minIndex := max(0, i-5)
			maxIndex1 := min(i+5, len(b1))
			maxIndex2 := min(i+5, len(b2))
			explanation := fmt.Sprintf("Bytes 1: %x^%x | Bytes 2: %x^%x", b1[minIndex:i], b1[i:maxIndex1], b2[minIndex:i], b2[i:maxIndex2])
			return i, errors.New(explanation)
		}
		i++
	}
}

func min(x, y int) int {
	if x < y {
		return x
	}
	return y
}

func max(x, y int) int {
	if x > y {
		return x
	}
	return y
}

func tailBytes(buf []byte, n int) []byte {
	start := max(0, len(buf)-n)
	return buf[start:]
}
